<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>		 
        <script src="https://projects.oregonlive.com/js/pym.js" type="text/javascript"></script>
		<link rel="stylesheet" href="https:////maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="https://projects.oregonlive.com/css/fonts.css">
        <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
        <script src="https://d3js.org/topojson.v1.min.js"></script>
        <script src="https://projects.oregonlive.com/js/colorbrewer.js"></script>
        <style>
            .bubble :hover { stroke: #000; }
            .legend circle { fill: none; stroke: #ccc; }
            .legend text { fill: #777; font: 10px sans-serif; text-anchor: middle; }
    		.map,.usmap { width:100%; position: relative; }
    		.usmap { margin-bottom: 30px; }
    		.land { fill: #ddd; stroke: #fff; stroke-linejoin: round; stroke-width: .5; }
    		.land.hover { stroke: #000; stroke-width: 1;}
    		.maptip { width: 150px; z-index: 5; }
            .popname { font-weight: bold; text-transform: uppercase; font-size: 12px; }
            .citylabel { font-size: 10px; font-weight: bold;  }
            .citylabel,.citybubble { fill: #666; opacity: .8;}
            .bubble { fill: brown; fill-opacity: .1; stroke: #900; stroke-width: .5px; }
            circle.active { stroke-width:2px;}
            .bubble :hover { stroke: #000; }
            .land { fill: #ddd; }
            .county:hover { stroke: #000; stroke-width: 2px;fill:#ccc; }
            .border { fill: none; stroke: #fff; stroke-linejoin: round; stroke-linecap: round; }
            .border--state { stroke-width: .7px; stroke:#fff; }
            .border--county { stroke-width: .4px; }
            .hideit { display:none; }
			.maptip { width: 150px; z-index: 5; }
            .popname { font-weight: bold; text-transform: uppercase; font-size: 12px; }
            circle.dot { fill-opacity: .7; }
            .dot { stroke: transparent; stroke-width: 8px; cursor: pointer; }
            .dot:hover { stroke: rgba(68,127,255,0.3)}
        </style>
    </head>
    <body>
        <div class="container">
        
             <div class="row">
                <div class="col-12">
                    <div class="usmap">
                        <div class='maptip hideit tip'></div>
                    </div>
                    
                    <div class="scatter"></div>
                    
                    
                </div>
            </div>
        </div>       
        
        
        
        
        
        
        
        
        
        <script>







			$(function() {
				var width = $(".usmap").width(),
				    height = width*.6,
				    margin = { top:20, right:0, bottom: 30, left: 40 },
				    scatterwidth = width,
				    scatterheight = width*.3;

				var projection = d3.geoAlbersUsa()
				    .scale([width*1.2])
                    .translate([(width/2)+3, (height/2)]);
				
				var path = d3.geoPath()
				    .projection(projection);
				
				var svg = d3.select(".usmap").append("svg")
				    .attr("width", width)
				    .attr("height", height);
				    
                d3.queue()
                    .defer(d3.json,"data/counties-10m.json")
                    .defer(d3.json,"data/data.json")
                    .await(ready)
		
                function ready(error, us, data) {
	                
                  if (error) return console.error(error);
                  
                  var countydata = [];
                  var domainArray = [];
                  data.forEach(function(d) {
                    countydata[d.id] = d;
                    var val = parseFloat(d.confirmed/d.population*1000);
                    domainArray.push(val);
                  });                


                  var counties = us.objects.counties.geometries;
                  counties.forEach(function(d) {
                      id = +d.id;
                      d.properties = countydata[id];
                  })                 
                
				var colorScale = d3.scaleQuantile()
				    .range(colorbrewer.Reds[6])
                    .domain(domainArray);
                
                   
                  svg.append("g")
                      .attr("class", "land")
                    .selectAll("path")
                       .data(topojson.feature(us, us.objects.states).features)
                    .enter().append("path")
                      .attr("d", path);
                      
                  svg.append("path")
                      .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b; }))
                      .attr("class", "border border--county")
                      .attr("d", path);
 
                   svg.append("g")
                      .attr("class", "counties")
                    .selectAll("path")
                       .data(topojson.feature(us, us.objects.counties).features)
                    .enter().append("path")
                      .attr("d", path)
		 		      .style("fill", function(d) {
    		 		      if (d.properties.confirmed>0) { 
                           var val = d.properties.confirmed/d.properties.population*1000;
                           return colorScale(val);
                           } else {
                               return "#ccc";
                           }
 		 		      })
                     
                  svg.append("path")
                      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
                      .attr("class", "border border--state")
                      .attr("d", path);
                

// scatterplot starts here
                    var x = d3.scaleLinear()
                        .range([0, scatterwidth]);
                        
                    var y = d3.scaleLinear()
                        .range([scatterheight, 0]);
                        
                    var xAxis = d3.axisBottom(x);
                    
                    var yAxis = d3.axisLeft(y);
                    
                    
                    var brush = d3.brush().extent([[0, 0], [scatterwidth, scatterheight]]).on("end",brushended),
                        idleTimeout,
                        idleDelay = 350;
                    
                    
    				var ssvg = d3.select(".scatter").append("svg")
    				    .attr("width", scatterwidth)
    				    .attr("height",scatterheight+margin.top+margin.bottom)
    				  .append("g")
    				    .attr("transform","translate("+margin.left+","+margin.top+")");
    				    
    				var clip = ssvg.append("defs").append("svg:clipPath")
                    	.attr("id", "clip")
                    	.append("svg:rect")
                    	.attr("width", scatterwidth)
                    	.attr("height", scatterheight)
                    	.attr("x", 0)
                    	.attr("y", 0);

    				    
                    var xExtent = d3.extent(data, function (d) { return d.population; });
                    var yExtent = d3.extent(data, function (d) { return d.confirmed; });
                    x.domain(d3.extent(data, function (d) { return d.population; })).nice();
                    y.domain(d3.extent(data, function (d) { return d.confirmed; })).nice();
    			
                    var scatter = ssvg.append("g")
                        .attr("id","scatterplot")
                        .attr("clip-path","url(#clip)");
    			
                   scatter.selectAll(".dot")
                      .data(data)
                    .enter().append("circle")
                      .attr("class", "dot")
                      .attr("r", 3.5)
                      .attr("cx", function(d) { return x(d.population); })
                      .attr("cy", function(d) { return y(d.confirmed); })
                      .style("fill", function(d) { 
    		 		      if (d.confirmed>0) { 
                           var val = d.confirmed/d.population*1000;
                           return colorScale(val);
                           } else {
                               return "#ccc";
                           }
                      });
   				
                  ssvg.append("g")
                      .attr("class", "x axis")
                      .attr("id","axis--x")
                      .attr("transform", "translate(0," + scatterheight + ")")
                      .call(xAxis);
                
                  ssvg.append("g")
                      .attr("class", "y axis")
                      .attr("id","axis--y")
                      .call(yAxis);
                                      

                  scatter.append("g")
                    .attr("class","brush")
                    .call(brush);
                    
                    
                function brushended() {
        
                    var s = d3.event.selection;
                    if (!s) {
                        if (!idleTimeout) return idleTimeout = setTimeout(idled, idleDelay);
                        x.domain(d3.extent(data, function (d) { return d.population; })).nice();
                        y.domain(d3.extent(data, function (d) { return d.confirmed; })).nice();
                    } else {
                        
                        x.domain([s[0][0], s[1][0]].map(x.invert, x));
                        y.domain([s[1][1], s[0][1]].map(y.invert, y));
                        scatter.select(".brush").call(brush.move, null);
                    }
                    zoom();
                }
        
                function idled() {
                    idleTimeout = null;
                }
        
                function zoom() {
        
                    var t = scatter.transition().duration(750);
                    ssvg.select("#axis--x").transition(t).call(xAxis);
                    ssvg.select("#axis--y").transition(t).call(yAxis);
                    scatter.selectAll("circle").transition(t)
                    .attr("cx", function (d) { return x(d.population); })
                    .attr("cy", function (d) { return y(d.confirmed); });
                }












				}
			});
           
            
            
            
        </script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    </body>
</html>