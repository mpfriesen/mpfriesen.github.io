<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" />
   <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />

    <link rel="stylesheet" href="https://use.typekit.net/ltb2sic.css">
    <link rel="stylesheet" href="../css/main.css">
    <title>Mark Friesen</title>
    <style type="text/css">
        body { background-color: #ddd; }
        h2 { font-weight: 700;}
        .container { padding: 0; }
        .guff { margin-bottom: 20px; }
        #map { width: 100%; height: 100%; }
        .infocol { height: 100%; overflow: auto; }
        p { margin: 0; }
        .hedblock { margin-top: 20px; }
        .tracts,#slider,.fa-pause,.year_block { display: none; }
        .controls { margin-left: 20px; }
        .button_block { margin-bottom: 20px; }
        .button_block .right-col { text-align: right; }
        .year_block,.tractbox { line-height: 110%; }
        .year_block h2,.tractbox h5 { color: #762a83; }
        h5 { margin: 20px 0 4px; }
        button.btn-secondary:not(:disabled):not(.disabled).button_pct.active { background-color: #762a83; border-color:#762a83; }
        button.btn-secondary:not(:disabled):not(.disabled).button_raw.active { background-color: #1b7837; border-color: #1b7837; }
        .credit { font-size: 10px; text-transform: uppercase; margin-top: 4px; }
        .info_hed { font-weight: 700; text-transform: uppercase; font-size: 16px; color: #777; margin-bottom:4px; }
        .info_num { font-weight: 700; font-size: 25px; margin-bottom: 8px; }
        .pct { font-size: 85%; }
    </style>
  </head>
  <body>
    <div class="container">
        <div class="row top_block">
            <div class="col-12">
                <div class="hedblock">
                    <h1>African-American population in Portland, 1940-2018</h1>
                    <div class="guff">
                        <p></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row button_block">
            <div class="col-lg-6">
                <div class="btn-group btn-group-sm census_years" role="group" aria-label="Census years">
                  <button type="button" class="btn button_0 btn-secondary active" data-position="0">1940</button>
                  <button type="button" class="btn button_1 btn-secondary" data-position="1">1950</button>
                  <button type="button" class="btn button_2 btn-secondary" data-position="2">1960</button>
                  <button type="button" class="btn button_3 btn-secondary" data-position="3">1970</button>
                  <button type="button" class="btn button_4 btn-secondary" data-position="4">1980</button>
                  <button type="button" class="btn button_5 btn-secondary" data-position="5">1990</button>
                  <button type="button" class="btn button_6 btn-secondary" data-position="6">2000</button>
                  <button type="button" class="btn button_7 btn-secondary" data-position="7">2010</button>
                  <button type="button" class="btn button_8 btn-secondary" data-position="8">2018</button>
                  <button type="button" class="btn btn-secondary"><i class="fa fa-play"></i><i class="fa fa-pause"></i></button>
                </div>
            </div>
            <div class="col-lg-3  col-sm-6 right-col">
                <div class="btn-group btn-group-sm census_type" role="group" aria-label="Map type">
                  <button type="button" class="btn button_pct btn-secondary active" data-type="pct">Percentages</button>
                  <button type="button" class="btn button_raw btn-secondary" data-type="raw">Numbers</button>
                </div>                
            </div>
            <div class="col-lg-3"></div>
        </div>
        <div class="row map_block">
            <div class="col-9">
                <div id="map"></div>
                <div class="credit">Sources: IPUMS NHGIS, University of Minnesota; Social Explorer; U.S. Census Bureau; City of Portland</div>
				<div id="slider"></div>	
            </div>
            <div class="col-3 infocol">
                <div class="infoyear"></div>
                <div class="infobox"></div>
                <div class="tractbox"></div>
            </div>
        </div>			




        
    </div>
    <script>
		function addCommas(x) {
		    return x.toString().replace(/\B(?=(?:\d{3})+(?!\d))/g, ",");
		}	  		

 		var yearSlide = [1940,1950,1960,1970,1980,1990,2000,2010,2018];
       
        var pdxrace =  {
          "1940": { "white":299707, "black":1931, "total":305394},
          "1950": { "white":360388, "black":9529, "total":373628},
          "1960": { "white":347068, "black":15615, "total":367912},
          "1970": { "white":376097, "black":21699, "total":406452},
          "1980": { "white":344455, "black":28288, "total":392695},
          "1990": { "white":399706, "black":33863, "total":468939},
          "2000": { "white":417934, "black":35185, "total":536072},
          "2010": { "white":449861, "black":36842, "total":590649},
          "2018": { "white":498862, "black":37596, "total":647250}
        }

		var winheight = $(window).height();
        var hedheight = $(".top_block").height();
        var buttonheight = $(".button_block").height();
        var creditheight = $(".credit").height();
        var mapheight = winheight-hedheight-buttonheight-creditheight-25;		
		$(".map_block").height(mapheight);


	  	var slidemin = 0,
	  		slidemax = yearSlide.length-1,
	  		slidestep = 1,
	  		slidestart = 0;

		$("#slider").slider({
		 	animate: "fast",
		    min: slidemin, 
		    max: slidemax, 
		    value: slidestart,
		    step: slidestep, 
		    slide: function(event, ui) {
		    	currentSlide = $("#slider").slider("value");
		    	nextSlide = ui.value;
		    	prevyear = yearSlide[currentSlide];
		    	if (currentSlide<nextSlide) {
			    	var dir = "up";
		    	} else {
			    	var dir = "down";
		    	}
		    	changeYear(nextSlide);
			}
		});



        
        $.getJSON('combined.geojson', function(data) {
			$.getJSON('pdx_limits.json', function(limitdata){

    			var weight = 0;
    			var fillop = .7;
    
    			map = L.map('map',{scrollWheelZoom:false});
 				map.createPane('boundaries');
				map.getPane('boundaries').style.pointerEvents = 'none';
   		
    
    			var sw = L.latLng(45.428653, -122.924641);
    			var ne = L.latLng(45.607003, -122.380946);
    			var bounds = L.latLngBounds(sw,ne);
    			map.fitBounds(bounds);
    
    			var cartodbAttribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, basemap tiles &copy; <a href="http://cartodb.com/attributions">CartoDB</a>';
    		
    			var positron = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
    				attribution: cartodbAttribution
    			}).addTo(map);
    			
    			var limits=[];
    			
    			for (x=0;x<9;x++) {
         			limits[x] = L.geoJson(limitdata.features[x], {
        				fillOpacity: 0,
        				weight: 2,
        				color:"#ccc",
        				dashArray: '3'
        			});
    			}
    			


    			function pop(feature,layer) {
        			layer.on("click",function(e) {
            			var p = e.target.feature.properties;
            			var tract = p.tract_name;
            			var blackpct = (p.black/p.total)*100;
            			var whitepct = (p.white/p.total)*100;
            			var tract = "<h5>"+p.county+" County<br>"+p.tract_name+"</h5>"
            			    + "<div class='info_hed'>Total</div>"
            			    + "<div class='info_num'>"+addCommas(p.total)+"</div>"
            			    + "<div class='info_hed'>African-American</div>"
            			    + "<div class='info_num'>"+addCommas(p.black)+" <span class='pct'>("+blackpct.toFixed(1)+"%)</span></div>"
            			    + "<div class='info_hed'>White</div>"
            			    + "<div class='info_num'>"+addCommas(p.white)+" <span class='pct'>("+whitepct.toFixed(1)+"%)</span></div>";
                        $(".tractbox").html("").html(tract);
                    })
    			}
    			
    			
          
    			var pctBlack = L.geoJson(data, {
    				onEachFeature: pop,
    				pointToLayer: function(feature,latlng) {
        				var color = "#762a83";
        				var white = feature.properties.white;
        				var total = feature.properties.total;
        				var year = feature.properties.year;
        				var black = feature.properties.black;
        				var pct = black/total;
                        var area = pct*800;
        				var r = Math.sqrt(area/Math.PI);
                        var yearclass = "tracts census_"+year;
        				
        				
        				var newmarker = new L.circleMarker(latlng, {
                            className: yearclass,
        					radius: r,
        					fillColor: color,
        					weight: 0,
        					fillOpacity: fillop
        				});
        
        				return newmarker;
        				
    				}
    			}).addTo(map).bringToFront();
    
    			var rawBlack = L.geoJson(data, {
    				onEachFeature: pop,
    				pointToLayer: function(feature,latlng) {
        				var color = "#1b7837";
        				var white = feature.properties.white;
        				var total = feature.properties.total;
        				var year = feature.properties.year;
        				var black = feature.properties.black;
                        var area = black/4;
        				var r = Math.sqrt(area/Math.PI);
                        var yearclass = "tracts census_"+year;
        				
        				
        				var newmarker = new L.circleMarker(latlng, {
                            className: yearclass,
        					radius: r,
        					fillColor: color,
        					weight: 0,
        					fillOpacity: fillop
        				});
        
        				return newmarker;
        				
    				}
    			});
    			
    			function changeType(type) {
                    $(".btn-group.census_type button").removeClass("active");
                    $(".button_"+type).addClass("active");
        			map.removeLayer(rawBlack);
        			map.removeLayer(pctBlack);
                    var position = $(".btn-group.census_years button.active").data("position");
        			if (type=="pct") {
            			pctBlack.addTo(map).bringToFront();
        			} else {
            			rawBlack.addTo(map).bringToFront();
        			}
                    changeYear(position);
    			}
    			
    			
                $(".btn-group.census_type button").on("click",function() {
                    changeType($(this).data("type"));
                })


                $(".btn-group.census_years button").on("click",function() {
                    var position = $(this).data("position");
                    changeYear(position);
                })
                
                function makePop(year) {
                    white = pdxrace[year].white;
                    black = pdxrace[year].black;
                    total = pdxrace[year].total;
                    blackpct = (black/total)*100;
                    
                    html = "<div class='year_block census_"+year+"'>"
                        + "<h2>"+year+"</h2>"
                        + "<div class='info_hed'>Total population</div>"
                        + "<div class='info_num'>"+addCommas(total)+"</div>"
                        + "<div class='info_hed'>African-American</div>"
                        + "<div class='info_num'>"+addCommas(black)+" <span class='pct'>("+blackpct.toFixed(1)+"%)</span></div>"
                        + "</div>";
                        
                    $(".infobox").html("").html(html);
                }
                
                function changeYear(position) {
                    var year = yearSlide[position];
                    makePop(year);
                    $(".btn-group.census_years button").removeClass("active");
                    $(".button_"+position).addClass("active");
                    $(".tracts").hide();
                    $(".census_"+year).show();
                    $(".tractbox").html("");
                    for (x=0;x<9;x++) {
                        map.removeLayer(limits[x]);
                    }
                    limits[position].addTo(map).bringToBack();
                }
         		
        		var id;
        	  
        		function playMap(sliderval) {
                    console.log(sliderval);
        			var loop=sliderval;
        			id = window.setInterval(function(){
        				loop++;
        				changeYear(loop);
        				$("#slider").slider("value", loop);
        				if (loop===slidemax) {
        					clearInterval(id);
        					$(".fa-play").toggle();
        					$(".fa-pause").toggle();
        				}
        			},1000);
        			
        		};
               
         		$('.fa-pause').on('click',function(e) {
        			e.preventDefault();
        			clearInterval(id);
        			$(".fa-play").toggle();
        			$(".fa-pause").toggle();
        		});
        	
        		$('.fa-play').on('click',function(e) {
        		    var s = $("#slider"), 
        				val = s.slider("value");
        			if (val==slidemax) {
        				val = -1;
        			}
        			e.preventDefault();
        			playMap(val);
        			$(".fa-play").toggle();
        			$(".fa-pause").toggle();
        		});
        		
        		changeYear(0);
	
            });
			

        })
       
    </script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    
    
    
    
  </body>
</html>